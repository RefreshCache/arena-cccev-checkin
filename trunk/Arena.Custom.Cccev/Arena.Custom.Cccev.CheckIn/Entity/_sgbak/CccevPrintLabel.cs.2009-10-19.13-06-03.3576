/**********************************************************************
* Description:	Class that handles printing check-in labels for children
*               who check in to a class.
* Created By:   Jason Offutt @ Central Christian Church of the East Valley
* Date Created:	2009-01-06
*
* $Workfile: CccevPrintLabel.cs $
* $Revision: 7 $ 
* $Header: /trunk/Arena.Custom.Cccev/Arena.Custom.Cccev.CheckIn/Entity/CccevPrintLabel.cs   7   2009-03-05 08:36:26-07:00   nicka $
* 
* $Log: /trunk/Arena.Custom.Cccev/Arena.Custom.Cccev.CheckIn/Entity/CccevPrintLabel.cs $
*  
*  Revision: 7   Date: 2009-03-05 15:36:26Z   User: nicka 
*  use nick name only if available else use first name 
*  
*  Revision: 6   Date: 2009-03-05 02:01:53Z   User: nicka 
*  Change label to use Nick name instead of First name 
*  
*  Revision: 5   Date: 2009-01-27 13:43:20Z   User: nicka 
*  change health notes to show until 1st grade 
*  
*  Revision: 4   Date: 2009-01-07 02:41:12Z   User: nicka 
*  Added logic to change Age Group based on age and or grade. Also only show 
*  Health Notes details if person under 2 years old. 
*  
*  Revision: 3   Date: 2009-01-07 00:21:01Z   User: JasonO 
*  
*  Revision: 2   Date: 2009-01-06 22:14:13Z   User: JasonO 
*  Sprint completion! 
*  
*  Revision: 1   Date: 2009-01-06 17:35:18Z   User: JasonO 
**********************************************************************/

using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

using Arena.Core;
using Arena.Organization;
using Arena.Custom.Cccev.DataUtils;

namespace Arena.Custom.Cccev.CheckIn.Entity
{
    class CccevPrintLabel : IPrintLabel
    {
        private Arena.Organization.Organization organization;
        private Location location;
        private CheckinLabel label;

        public CccevPrintLabel()
        {
            label = new CheckinLabel();
            organization = ArenaContext.Current.Organization;
        }

        /// <summary>
        /// IPrintLabel implementation to print out name tags.
        /// </summary>
        /// <param name="person"><see cref="Arena.Core.FamilyMember">FamilyMember</see> person attending</param>
        /// <param name="occurrences">IEnumerable<<see cref="Arena.Core.Occurrence">Occurrence</see>> of services</param>
        /// <param name="attendance"><see cref="Arena.Core.OccurrenceAttendance">OccurrenceAttendance</see> attendance record</param>
        void IPrintLabel.Print(FamilyMember attendee, IEnumerable<Occurrence> occurrences, OccurrenceAttendance attendance)
        {
            InitLabel(attendee, occurrences, attendance);
            location = new Location(occurrences.First().LocationID);
            label.PrintAllLabels(location.Printer.PrinterName);
        }

		/// <summary>
		/// Intialize a person's label set with the information from the given person, occurrence(s),
		/// and attendance record.
		/// </summary>
		/// <param name="attendee"></param>
		/// <param name="occurrences"></param>
		/// <param name="attendance"></param>
        private void InitLabel(FamilyMember attendee, IEnumerable<Occurrence> occurrences, OccurrenceAttendance attendance)
        {
			label.FirstName = attendee.NickName.Trim() != string.Empty ? attendee.NickName : attendee.FirstName;
            label.LastName = attendee.LastName;
            label.FullName = string.Format("{0} {1}", attendee.NickName, attendee.LastName);
            label.SecurityToken = attendance.SecurityCode;
            label.CheckInDate = attendance.CheckInTime;
            StringBuilder services = new StringBuilder();

            foreach (Occurrence o in occurrences)
            {
                if (services.Length > 0)
                    services.Append(", ");

                services.Append(o.StartTime.ToShortTimeString());
            }

            label.Services = services.ToString();
            label.BirthdayDate = attendee.BirthDate;
			SetAgeGroup( attendee );
            SetLabelFlags(attendee);
            LoadOrgSettings();
        }

		/// <summary>
		/// Set these global label values based on the Org settings
		/// </summary>
        private void LoadOrgSettings()
        {
            label.AttendanceLabelTitle = organization.Settings["Cccev.AttendanceLabelTitle"];
            label.BirthdayImageFile = organization.Settings["Cccev.BirthdayImageFile"];
            label.Footer = organization.Settings["Cccev.ClaimCardFooter"];
            label.ClaimCardTitle = organization.Settings["Cccev.ClaimCardTitle"];
            label.HealthNotesTitle = organization.Settings["Cccev.HealthNotesTitle"];
            label.LogoImageFile = organization.Settings["Cccev.LogoImageFile"];
            label.ParentsInitialsTitle = organization.Settings["Cccev.ParentsInitialsTitle"];
            label.ServicesTitle = organization.Settings["Cccev.ServicesLabel"];
        }

		/// <summary>
		/// This method will set the label's flags and health notes for the given person.
		/// </summary>
		/// <param name="attendee"></param>
        private void SetLabelFlags(FamilyMember attendee)
        {
            PersonAttribute selfCheckOut = new PersonAttribute(attendee.PersonID, int.Parse(organization.Settings["Cccev.SelfCheckOutAttributeID"]));
            PersonAttribute legalNotes = new PersonAttribute(attendee.PersonID, int.Parse(organization.Settings["Cccev.LegalNotesAttributeID"]));
            PersonAttribute healthNotes = new PersonAttribute(attendee.PersonID, int.Parse(organization.Settings["Cccev.HealthNotesAttributeID"]));

            label.SelfCheckOutFlag = (selfCheckOut.IntValue.Equals(1));
            label.LegalNoteFlag = (!legalNotes.StringValue.Equals(string.Empty));

			if ( !healthNotes.StringValue.Equals( string.Empty ) )
			{
				label.HealthNoteFlag = true;
				// This was removed after speaking with Laurie (NA 1/26/2009)
				// Don't print health notes if child greater than 1st grade.
				//if ( !( attendee.GraduationDate > DateTime.Parse( "1/1/1900" )
				//    && Person.CalculateGradeLevel( attendee.GraduationDate, organization.GradePromotionDate ) >= 1 ) )
				//{
					label.HealthNotes = healthNotes.StringValue;
				//}
			}
			else
			{
				label.HealthNoteFlag = false;
			}
        }

		/// <summary>
		/// This sets the label's "Age Group" value to a specific text (as per Children's
		/// ministries) based on the person's age and or grade.
		/// Basically:
		///		* if the person is under the age of 2, display age in months;
		///     * if they are in grade school, display the grade
		///		* otherwise display age in years.
		/// </summary>
		/// <param name="attendee"></param>
		private void SetAgeGroup( FamilyMember attendee )
		{
			if ( attendee.Age < 2 )
			{
				label.AgeGroup = String.Format( "{0} months", DateUtils.GetAgeInMonths( attendee.BirthDate ) );
			}
			else
			{
				int grade = Person.CalculateGradeLevel( attendee.GraduationDate, organization.GradePromotionDate );
				if ( grade > -1 )
				{
					label.AgeGroup = String.Format( "{0} grade", Person.GetGradeName( grade ) );
				}
				else
				{
					label.AgeGroup = String.Format( "{0} year olds", attendee.Age );
				}
			}
		}
    }
}
